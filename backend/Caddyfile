# Caddyfile for Apsara Dark Backend
# Deploy on Oracle Cloud (or any VPS) with Caddy v2
#
# Append this block to your existing /etc/caddy/Caddyfile
# Then: sudo caddy fmt --overwrite /etc/caddy/Caddyfile
#       sudo systemctl restart caddy
#
# Caddy will auto-provision TLS via Let's Encrypt.

apsara-dark-backend.devshubh.me {
	# Reverse proxy with immediate flush for WebSocket streaming.
	# flush_interval -1 disables response buffering â€” critical for WebSocket
	# frames to pass through without Caddy fragmenting control frames
	# (which causes "Control frames must be final" errors).
	reverse_proxy localhost:3012 {
		flush_interval -1
	}

	# Allow iframe embedding for canvas render endpoints
	@canvasRender path /api/canvas/*/render
	header @canvasRender {
		X-Content-Type-Options nosniff
		Referrer-Policy strict-origin-when-cross-origin
		-X-Frame-Options
		Content-Security-Policy "frame-ancestors *"
	}

	# Default headers for everything else
	@notCanvas not path /api/canvas/*/render
	header @notCanvas {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		Referrer-Policy strict-origin-when-cross-origin
	}
}
